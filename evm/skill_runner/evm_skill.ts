import {
  createPublicClient, createWalletClient, http, parseEther,
  encodeFunctionData, getContractAddress, type Hex, type Address,
  parseAbi, keccak256, toHex, pad, encodePacked, concat, toBytes,
} from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import { anvil } from 'viem/chains';


export async function executeSkill(rpcUrl: string, privateKey: string, chainId: number = 31337): Promise<string> {

  const account = privateKeyToAccount(privateKey as Hex);
  const chain = { ...anvil, id: chainId };
  const publicClient = createPublicClient({ chain, transport: http(rpcUrl) });
  const walletClient = createWalletClient({ account, chain, transport: http(rpcUrl) });
  const results: Array<{txHash: string; to: string; selector: string; success: boolean; deployedAddress?: string}> = [];


  async function sendAndTrack(params: {to?: Address | null; data?: Hex; value?: bigint}) {
    try {
      const txHash = await walletClient.sendTransaction({
        to: params.to ?? undefined, data: params.data, value: params.value ?? 0n,
      });
      const receipt = await publicClient.waitForTransactionReceipt({ hash: txHash });
      const selector = params.data && params.data.length >= 10 ? params.data.slice(0, 10) : '0x';
      const toAddr = params.to ?? '0x0000000000000000000000000000000000000000';
      results.push({
        txHash, to: toAddr, selector, success: receipt.status === 'success',
        deployedAddress: receipt.contractAddress ?? undefined,
      });
      return { receipt, txHash, deployedAddress: receipt.contractAddress };
    } catch (e: unknown) {
      results.push({
        txHash: '', to: params.to ?? '0x0000000000000000000000000000000000000000',
        selector: params.data?.slice(0, 10) ?? '0x', success: false,
      });
      return { receipt: null, txHash: '', deployedAddress: undefined };
    }
  }


  const ERC1155_ABI = parseAbi([
    'function mint(address,uint256,uint256,bytes)', 'function safeTransferFrom(address,address,uint256,uint256,bytes)',
    'function setApprovalForAll(address,bool)', 'function balanceOf(uint256,address) view returns (uint256)',
    'function uri(uint256) view returns (string)', 'function supportsInterface(bytes4) view returns (bool)',
    'function isApprovedForAll(address,address) view returns (bool)',
  ]);
  const { deployedAddress: addr } = await sendAndTrack({ to: null, data: '0x6080604052348015600e575f5ffd5b50610d8e8061001c5f395ff3fe608060405234801561000f575f5ffd5b5060043610610090575f3560e01c80634e1273f4116100635780634e1273f414610159578063731133e914610179578063a22cb4651461018c578063e985e9c51461019f578063f242432a146101cc575f5ffd5b806301ffc9a7146100945780630e89341c146100bc5780632eb2c2d61461010f5780633656eec214610124575b5f5ffd5b6100a76100a2366004610893565b6101df565b60405190151581526020015b60405180910390f35b6101026100ca3660046108c1565b5060408051808201909152601d81527f68747470733a2f2f62656e63682e746573742f6d756c74692f7b69647d000000602082015290565b6040516100b391906108d8565b61012261011d3660046109ae565b610215565b005b61014b610132366004610a6d565b5f60208181529281526040808220909352908152205481565b6040519081526020016100b3565b61016c610167366004610a97565b6104dc565b6040516100b39190610b03565b610122610187366004610b45565b61060e565b61012261019a366004610ba8565b610691565b6100a76101ad366004610be1565b600160209081525f928352604080842090915290825290205460ff1681565b6101226101da366004610c09565b6106fc565b5f636cdb3d1360e11b6001600160e01b03198316148061020f57506301ffc9a760e01b6001600160e01b03198316145b92915050565b6001600160a01b03881633148061024e57506001600160a01b0388165f90815260016020908152604080832033845290915290205460ff165b6102905760405162461bcd60e51b815260206004820152600e60248201526d1b9bdd08185d5d1a1bdc9a5e995960921b60448201526064015b60405180910390fd5b8483146102d15760405162461bcd60e51b815260206004820152600f60248201526e0d8cadccee8d040dad2e6dac2e8c6d608b1b6044820152606401610287565b5f5b85811015610476578484828181106102ed576102ed610c7c565b905060200201355f5f89898581811061030857610308610c7c565b9050602002013581526020019081526020015f205f8b6001600160a01b03166001600160a01b031681526020019081526020015f205410156103835760405162461bcd60e51b8152602060048201526014602482015273696e73756666696369656e742062616c616e636560601b6044820152606401610287565b84848281811061039557610395610c7c565b905060200201355f5f8989858181106103b0576103b0610c7c565b9050602002013581526020019081526020015f205f8b6001600160a01b03166001600160a01b031681526020019081526020015f205f8282546103f39190610ca4565b90915550859050848281811061040b5761040b610c7c565b905060200201355f5f89898581811061042657610426610c7c565b9050602002013581526020019081526020015f205f8a6001600160a01b03166001600160a01b031681526020019081526020015f205f8282546104699190610cb7565b90915550506001016102d3565b50866001600160a01b0316886001600160a01b0316336001600160a01b03167f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb898989896040516104ca9493929190610cfa565b60405180910390a45050505050505050565b606083821461051f5760405162461bcd60e51b815260206004820152600f60248201526e0d8cadccee8d040dad2e6dac2e8c6d608b1b6044820152606401610287565b5f8467ffffffffffffffff81111561053957610539610d2b565b604051908082528060200260200182016040528015610562578160200160208202803683370190505b5090505f5b85811015610604575f5f86868481811061058357610583610c7c565b9050602002013581526020019081526020015f205f8888848181106105aa576105aa610c7c565b90506020020160208101906105bf9190610d3f565b6001600160a01b03166001600160a01b031681526020019081526020015f20548282815181106105f1576105f1610c7c565b6020908102919091010152600101610567565b5095945050505050565b5f848152602081815260408083206001600160a01b03891684529091528120805485929061063d908490610cb7565b909155505060408051858152602081018590526001600160a01b038716915f9133917fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62910160405180910390a45050505050565b335f8181526001602090815260408083206001600160a01b03871680855290835292819020805460ff191686151590811790915590519081529192917f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31910160405180910390a35050565b6001600160a01b03861633148061073557506001600160a01b0386165f90815260016020908152604080832033845290915290205460ff165b6107725760405162461bcd60e51b815260206004820152600e60248201526d1b9bdd08185d5d1a1bdc9a5e995960921b6044820152606401610287565b5f848152602081815260408083206001600160a01b038a1684529091529020548311156107d85760405162461bcd60e51b8152602060048201526014602482015273696e73756666696369656e742062616c616e636560601b6044820152606401610287565b5f848152602081815260408083206001600160a01b038a16845290915281208054859290610807908490610ca4565b90915550505f848152602081815260408083206001600160a01b03891684529091528120805485929061083b908490610cb7565b909155505060408051858152602081018590526001600160a01b03808816929089169133917fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62910160405180910390a4505050505050565b5f602082840312156108a3575f5ffd5b81356001600160e01b0319811681146108ba575f5ffd5b9392505050565b5f602082840312156108d1575f5ffd5b5035919050565b602081525f82518060208401528060208501604085015e5f604082850101526040601f19601f83011684010191505092915050565b80356001600160a01b0381168114610923575f5ffd5b919050565b5f5f83601f840112610938575f5ffd5b50813567ffffffffffffffff81111561094f575f5ffd5b6020830191508360208260051b8501011115610969575f5ffd5b9250929050565b5f5f83601f840112610980575f5ffd5b50813567ffffffffffffffff811115610997575f5ffd5b602083019150836020828501011115610969575f5ffd5b5f5f5f5f5f5f5f5f60a0898b0312156109c5575f5ffd5b6109ce8961090d565b97506109dc60208a0161090d565b9650604089013567ffffffffffffffff8111156109f7575f5ffd5b610a038b828c01610928565b909750955050606089013567ffffffffffffffff811115610a22575f5ffd5b610a2e8b828c01610928565b909550935050608089013567ffffffffffffffff811115610a4d575f5ffd5b610a598b828c01610970565b999c989b5096995094979396929594505050565b5f5f60408385031215610a7e575f5ffd5b82359150610a8e6020840161090d565b90509250929050565b5f5f5f5f60408587031215610aaa575f5ffd5b843567ffffffffffffffff811115610ac0575f5ffd5b610acc87828801610928565b909550935050602085013567ffffffffffffffff811115610aeb575f5ffd5b610af787828801610928565b95989497509550505050565b602080825282518282018190525f918401906040840190835b81811015610b3a578351835260209384019390920191600101610b1c565b509095945050505050565b5f5f5f5f5f60808688031215610b59575f5ffd5b610b628661090d565b94506020860135935060408601359250606086013567ffffffffffffffff811115610b8b575f5ffd5b610b9788828901610970565b969995985093965092949392505050565b5f5f60408385031215610bb9575f5ffd5b610bc28361090d565b915060208301358015158114610bd6575f5ffd5b809150509250929050565b5f5f60408385031215610bf2575f5ffd5b610bfb8361090d565b9150610a8e6020840161090d565b5f5f5f5f5f5f60a08789031215610c1e575f5ffd5b610c278761090d565b9550610c356020880161090d565b94506040870135935060608701359250608087013567ffffffffffffffff811115610c5e575f5ffd5b610c6a89828a01610970565b979a9699509497509295939492505050565b634e487b7160e01b5f52603260045260245ffd5b634e487b7160e01b5f52601160045260245ffd5b8181038181111561020f5761020f610c90565b8082018082111561020f5761020f610c90565b8183525f6001600160fb1b03831115610ce1575f5ffd5b8260051b80836020870137939093016020019392505050565b604081525f610d0d604083018688610cca565b8281036020840152610d20818587610cca565b979650505050505050565b634e487b7160e01b5f52604160045260245ffd5b5f60208284031215610d4f575f5ffd5b6108ba8261090d56fea2646970667358221220057b2a85baed9c67b39a1567346ba7387d44b0ed995a60a0f425a078fad1d07c64736f6c63430008210033' as Hex });
  if (!addr) return JSON.stringify({ results, error: 'ERC1155 deploy failed' });
  const mt = addr as Address;
  const dead = '0x000000000000000000000000000000000000dEaD' as Address;
  // Mint token id=1, amount=100
  await sendAndTrack({ to: mt, data: encodeFunctionData({ abi: ERC1155_ABI, functionName: 'mint', args: [account.address, 1n, 100n, '0x'] }) });
  // safeTransferFrom
  await sendAndTrack({ to: mt, data: encodeFunctionData({ abi: ERC1155_ABI, functionName: 'safeTransferFrom', args: [account.address, dead, 1n, 10n, '0x'] }) });
  // setApprovalForAll
  await sendAndTrack({ to: mt, data: encodeFunctionData({ abi: ERC1155_ABI, functionName: 'setApprovalForAll', args: [dead, true] }) });
  // balanceOf (view via tx)
  await sendAndTrack({ to: mt, data: encodeFunctionData({ abi: ERC1155_ABI, functionName: 'balanceOf', args: [1n, account.address] }) });
  // uri
  await sendAndTrack({ to: mt, data: encodeFunctionData({ abi: ERC1155_ABI, functionName: 'uri', args: [1n] }) });
  // supportsInterface
  await sendAndTrack({ to: mt, data: encodeFunctionData({ abi: ERC1155_ABI, functionName: 'supportsInterface', args: ['0xd9b67a26'] }) });
  // isApprovedForAll
  await sendAndTrack({ to: mt, data: encodeFunctionData({ abi: ERC1155_ABI, functionName: 'isApprovedForAll', args: [account.address, dead] }) });


  return JSON.stringify({ results, error: null });
}
